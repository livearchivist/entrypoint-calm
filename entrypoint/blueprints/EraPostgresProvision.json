{"status":{},"contains_secrets":false,"product_version":"2.9.8","spec":{"description":"","resources":{"client_attrs":{"None":{"y":-5.5,"x":967.953125},"f6be2786_deployment":{"y":-325.1265146707,"x":1089.8915520502},"68fbb2c6_deployment":{"y":-342.6265106201,"x":1484.6650390625}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"TakeSnapshot"}],"name":"6fba9cbb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"TakeSnapshot","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"c6692992_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"01945104_runbook","main_task_local_reference":{"kind":"app_task","name":"6fba9cbb_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8bee20f0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"fe42eb38_runbook","main_task_local_reference":{"kind":"app_task","name":"8bee20f0_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"04cc6e24_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ffd25064_runbook","main_task_local_reference":{"kind":"app_task","name":"04cc6e24_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9d7e4dfb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ef6acd35_runbook","main_task_local_reference":{"kind":"app_task","name":"9d7e4dfb_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"897e9b24_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b81e8f8b_runbook","main_task_local_reference":{"kind":"app_task","name":"897e9b24_dag"},"variable_list":[]},"name":"action_stop"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1GetTimeMachineID"},{"kind":"app_task","name":"2TakeSnapshot"},{"kind":"app_task","name":"3MonitorOperation"}],"name":"0bdb28e0_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1GetTimeMachineID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2TakeSnapshot"}},{"from_task_reference":{"kind":"app_task","name":"2TakeSnapshot"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3MonitorOperation"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1GetTimeMachineID","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Time Machine ID\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/name\/@@{db_name}@@_tm?load-drive=false\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"TM_ID={0}\".format(json.loads(resp.content)['id'])\nelse:\n  print \"Get Time Machine ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["TM_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2TakeSnapshot","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Set the URL and payload\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/@@{TM_ID}@@\/snapshots\"\npayload = {\n  \"actionHeader\": [\n    {\n      \"name\": \"snapshotName\",\n      \"value\": \"@@{db_name}@@_snap_@@{calm_time(\"%Y%m%d%H%M\")}@@\"\n    }\n  ]\n}\n\n# Make the call and set the response operation ID to the variable\nresp = urlreq(url, verb='POST', auth='BASIC', user=era_user, passwd=era_pass, params=json.dumps(payload), headers=headers)\nif resp.ok:\n  print \"SNAP_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Post Database create request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["SNAP_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3MonitorOperation","attrs":{"exit_status":[],"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{SNAP_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 20 seconds.\"\n  sleep(20)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break\n\n# If the operation did not complete within 3 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Get Operation ID timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get the newly provision DB Entity Name and set it to a variable\nprint \"SNAP_ENTITY_ID={0}\".format(json.loads(resp.content)['entityId'])","eval_variables":["SNAP_ENTITY_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"c6692992_runbook","main_task_local_reference":{"kind":"app_task","name":"0bdb28e0_dag"},"variable_list":[]},"name":"TakeSnapshot"}],"depends_on_list":[],"name":"Postgres","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"TM_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SNAP_OPERATION_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SNAP_ENTITY_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"950d1346_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b80bb69e_runbook","main_task_local_reference":{"kind":"app_task","name":"950d1346_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"47e0fbe7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6e12df09_runbook","main_task_local_reference":{"kind":"app_task","name":"47e0fbe7_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1747bd24_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"28812892_runbook","main_task_local_reference":{"kind":"app_task","name":"1747bd24_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"63dc1827_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f58b7121_runbook","main_task_local_reference":{"kind":"app_task","name":"63dc1827_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"d220f313_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4627f857_runbook","main_task_local_reference":{"kind":"app_task","name":"d220f313_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[{"kind":"app_service","name":"Postgres"}],"name":"Postgres_Clone","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1GetClusterID"},{"kind":"app_task","name":"2GetProfileIDs"},{"kind":"app_task","name":"3GetSLAID"},{"kind":"app_task","name":"4ProvisionDB"},{"kind":"app_task","name":"5MonitorOperation"},{"kind":"app_task","name":"6GetDatabaseInfo"}],"name":"2a5c1fa7_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1GetClusterID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2GetProfileIDs"}},{"from_task_reference":{"kind":"app_task","name":"2GetProfileIDs"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3GetSLAID"}},{"from_task_reference":{"kind":"app_task","name":"3GetSLAID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4ProvisionDB"}},{"from_task_reference":{"kind":"app_task","name":"4ProvisionDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"5MonitorOperation"}},{"from_task_reference":{"kind":"app_task","name":"5MonitorOperation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"6GetDatabaseInfo"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1GetClusterID","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Cluster ID\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/clusters\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"CLUSTER_ID={0}\".format(json.loads(resp.content)[0]['id'])\nelse:\n  print \"Get Cluster ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CLUSTER_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2GetProfileIDs","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Software Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Software&name=@@{software_profile}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"SOFTWARE_PROF_ID={0}\".format(json.loads(resp.content)['id'])\nelse:\n  print \"Get Software Profile ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get Compute Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Compute&name=@@{compute_profile}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"COMPUTE_PROF_ID={0}\".format(json.loads(resp.content)['id'])\nelse:\n  print \"Get Compute Profile ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get Network Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Network&name=@@{network_profile}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"NETWORK_PROF_ID={0}\".format(json.loads(resp.content)['id'])\nelse:\n  print \"Get Network Profile ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get DB Parameter ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Database_Parameter&name=@@{database_parameter}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"DB_PARAM_ID={0}\".format(json.loads(resp.content)['id'])\nelse:\n  print \"Get DB Parameter ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["COMPUTE_PROF_ID","DB_PARAM_ID","NETWORK_PROF_ID","SOFTWARE_PROF_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3GetSLAID","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get the list of SLAs\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/slas\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\n# Find the desired SLA, and set the corresponding ID to the variable\nif resp.ok:\n  for sla in json.loads(resp.content):\n    if sla['name'] == \"@@{sla_name}@@\":\n      print \"SLA_ID={0}\".format(sla['id'])\nelse:\n  print \"Get SLA request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["SLA_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4ProvisionDB","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Set the URL and payload\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/provision\"\npayload = {\n  \"databaseName\": \"@@{db_name}@@\",\n  \"databaseType\": \"postgres_database\",\n  \"databaseDescription\": \"Postgres database provisioned by Calm Application @@{calm_application_name}@@\",\n  \"clusterId\": \"@@{CLUSTER_ID}@@\",\n  \"softwareProfileId\": \"@@{SOFTWARE_PROF_ID}@@\",\n  \"computeProfileId\": \"@@{COMPUTE_PROF_ID}@@\",\n  \"networkProfileId\": \"@@{NETWORK_PROF_ID}@@\",\n  \"dbParameterProfileId\": \"@@{DB_PARAM_ID}@@\",\n  \"provisionInfo\": [\n    {\n      \"name\": \"application_type\",\n      \"value\": \"postgres_database\"\n    },\n    {\n      \"name\": \"listener_port\",\n      \"value\": \"5432\"\n    },\n    {\n      \"name\": \"database_size\",\n      \"value\": \"200\"\n    },\n    {\n      \"name\": \"working_dir\",\n      \"value\": \"\/tmp\"\n    },\n    {\n      \"name\": \"auto_tune_staging_drive\",\n      \"value\": True\n    },\n    {\n      \"name\": \"db_password\",\n      \"value\": \"@@{db_password}@@\"\n    },\n    {\n      \"name\": \"dbserver_name\",\n      \"value\": \"@@{db_name}@@\"\n    },\n    {\n      \"name\": \"dbserver_description\",\n      \"value\": \"Postgres database server provisioned by Calm Application \"\n    },\n    {\n      \"name\": \"ssh_public_key\",\n      \"value\": \"@@{db_server_creds.public_key}@@\"\n    }\n  ],\n  \"timeMachineInfo\": {\n    \"name\": \"@@{db_name}@@_TM\",\n    \"description\": \"@@{db_name}@@ time machine\",\n    \"slaId\": \"@@{SLA_ID}@@\",\n    \"schedule\": {\n      \"continuousSchedule\": {\n        \"enabled\": True,\n        \"logBackupInterval\": 30,\n        \"snapshotsPerDay\": 30\n      },\n      \"snapshotTimeOfDay\": {\n        \"hours\": 1,\n        \"minutes\": 0,\n        \"seconds\": 0\n      },\n      \"weeklySchedule\": {\n        \"enabled\": True,\n        \"dayOfWeek\": \"SUNDAY\"\n      },\n      \"monthlySchedule\": {\n        \"enabled\": True,\n        \"dayOfMonth\": 1\n      },\n      \"quartelySchedule\": {\n        \"enabled\": True,\n        \"startMonth\": \"JANUARY\",\n        \"dayOfMonth\": 1\n      },\n      \"yearlySchedule\": {\n        \"enabled\": False,\n        \"month\": \"DECEMBER\",\n        \"dayOfMonth\": 1\n      }\n    }\n  }\n}\n\n# Make the call and set the response operation ID to the variable\nresp = urlreq(url, verb='POST', auth='BASIC', user=era_user, passwd=era_pass, params=json.dumps(payload), headers=headers)\nif resp.ok:\n  print json.dumps(json.loads(resp.content), indent=4)\n  print \"CREATE_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Post Database create request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CREATE_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5MonitorOperation","attrs":{"exit_status":[],"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CREATE_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(40):\n  \n  print \"Sleeping for 60 seconds.\"\n  sleep(60)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break\n\n# If the operation did not complete within 20 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Get Operation ID timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get the newly provision DB Entity Name and set it to a variable\nprint \"DB_ENTITY_NAME={0}\".format(json.loads(resp.content)['entityName'])","eval_variables":["DB_ENTITY_NAME"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6GetDatabaseInfo","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get DB Server IP and ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/name\/@@{DB_ENTITY_NAME}@@?detailed=true\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"DB_SERVER_IP={0}\".format(json.loads(resp.content)['hostIP'])\n  print \"DB_ID={0}\".format(json.loads(resp.content)['id'])\n  print \"DB_SERVER_ID={0}\".format(json.loads(resp.content)['primaryHost'])\nelse:\n  print \"Get DB infor request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["DB_ID","DB_SERVER_ID","DB_SERVER_IP"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"80b56e92_runbook","main_task_local_reference":{"kind":"app_task","name":"2a5c1fa7_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1CleanupDB"},{"kind":"app_task","name":"2MonitorCleanupOp"},{"kind":"app_task","name":"3DeregisterDBServer"},{"kind":"app_task","name":"4MonitorDeregOp"}],"name":"7e11c457_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1CleanupDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2MonitorCleanupOp"}},{"from_task_reference":{"kind":"app_task","name":"2MonitorCleanupOp"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3DeregisterDBServer"}},{"from_task_reference":{"kind":"app_task","name":"3DeregisterDBServer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4MonitorDeregOp"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1CleanupDB","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Cleanup the DB and get Operation ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/@@{DB_ID}@@?storage-cleanup=true&tm-cleanup=true\"\nresp = urlreq(url, verb='DELETE', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"CLEANUP_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Cleanup DB Operation failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CLEANUP_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2MonitorCleanupOp","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CLEANUP_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 30 seconds.\"\n  sleep(30)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 10 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Cleanup Operation timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3DeregisterDBServer","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Cleanup the DB and get Operation ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/dbservers\/@@{DB_SERVER_ID}@@?remove=false&soft-remove=false&delete=true&delete-vm-snapshots=true&delete-vgs=true\"\nresp = urlreq(url, verb='DELETE', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"DEREGISTER_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Deregister DB Server Operation failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["DEREGISTER_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4MonitorDeregOp","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{DEREGISTER_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 30 seconds.\"\n  sleep(30)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 10 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Deregistration Operation timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"9830ed47_runbook","main_task_local_reference":{"kind":"app_task","name":"7e11c457_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"EXISTING_VM","name":"Era_PostgreSQL_DB","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"db_server_creds"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{DB_SERVER_IP}@@"},"variable_list":[]},{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1GetDbHostInfo"},{"kind":"app_task","name":"2ValidateSnapID"},{"kind":"app_task","name":"3GetInputFile"},{"kind":"app_task","name":"4GetProfileIDs"},{"kind":"app_task","name":"5CloneDb"},{"kind":"app_task","name":"6MonitorOperation"},{"kind":"app_task","name":"7GetDatabaseInfo"}],"name":"67bda28d_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1GetDbHostInfo"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2ValidateSnapID"}},{"from_task_reference":{"kind":"app_task","name":"2ValidateSnapID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3GetInputFile"}},{"from_task_reference":{"kind":"app_task","name":"3GetInputFile"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4GetProfileIDs"}},{"from_task_reference":{"kind":"app_task","name":"4GetProfileIDs"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"5CloneDb"}},{"from_task_reference":{"kind":"app_task","name":"5CloneDb"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"6MonitorOperation"}},{"from_task_reference":{"kind":"app_task","name":"6MonitorOperation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"7GetDatabaseInfo"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1GetDbHostInfo","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Set Time Machine ID by doing a GET on the Database\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/name\/@@{db_name}@@?detailed=true\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\n# If the response is ok, set to our TM_ID variable\nif resp.ok:\n#  print \"TM_ID={0}\".format(json.loads(resp.content)['timeMachineId'])\n  print \"SOURCE_DBSERVER_ID={0}\".format(json.loads(resp.content)['primaryHost'])\n\n# If it is not, make a new call to get list of possible databases\nelse:\n  print \"Error: Database named '@@{db_name}@@' was not found.\"\n  print \"\"\n  print \"The valid database_name values on this Era server are:\"\n  print \"======================================================\"\n  \n  url  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\"\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  \n  for dbs in json.loads(resp.content):\n    if not dbs['clone']:\n      print dbs['name']\n  \n  print \"======================================================\"\n  print \"Please use one of the above databases, and try again.\"\n  exit(1)","eval_variables":["SOURCE_DBSERVER_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2ValidateSnapID","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Time Machine Capability\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/@@{Postgres.TM_ID}@@\/capability?summary=false&time-zone=UTC\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\nif resp.ok:\n  \n  # Cycle through the snapshot modes\n  for modes in json.loads(resp.content)['capability']:\n    \n    # Cycle through the snapshots if they exist and find our manual snapshot\n    if modes['snapshots'] and modes['mode'] == \"MANUAL\":\n      for snapshot in modes['snapshots']:\n        print \"VALIDATED_SNAP_ID={0}\".format(snapshot['id'])\n        exit(0)\n        \n  # If we've gotten to this point, the SnapshotID macro is not a valid Snap ID, so error out\n  print \"ERROR: The Snapshot ID you entered is not valid. You must either:\"\n  print \"  1. Provide a valid Snapshot ID from the list below, or\"\n  print \"  2. Leave the SnapshotID field blank to use the last Snapshot.\"\n  print \"  ========================\"\n\n  # Cycle through the snapshot modes\n  for modes in json.loads(resp.content)['capability']:\n    print \"{0} MODE\".format(modes['mode'])\n  \n    # Cycle through the snapshots if they exist\n    if modes['snapshots']:\n      for snapshot in modes['snapshots']:\n        print \"  ------------------------\"\n        print \"  Snapshot ID (copy this): {0}\".format(snapshot['id'])\n        print \"  Snapshot Time Stamp:     {0}\".format(snapshot['snapshotTimeStamp'])\n      \n    # Print message if the don't exist\n    else:\n      print \"  ------------------------\"\n      print \"  No {0} snapshots exist.\".format(modes['mode'].lower())\n\n  exit(1)\n\n# In the event something went wrong with the API call\nelse:\n  print \"Get Time Machine Capability request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["VALIDATED_SNAP_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3GetInputFile","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Time Machine Capability\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/@@{Postgres.TM_ID}@@\/clones\/input-file?category=database%3Bvm_info\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\nif resp.ok:\n  \n  # Cycle through the various properties\n  for property in json.loads(resp.content)['properties']:\n    \n    # Set the various variables\n    if property['name'] == \"vm_name\":\n      print \"VM_NAME={0}\".format(property['default_value'])\n    elif property['name'] == \"working_dir\":\n      print \"WORKING_DIR={0}\".format(property['default_value'])\n    elif property['name'] == \"era_deploy_base\":\n      print \"ERA_BASE={0}\".format(property['default_value'])\n\n# In the event something went wrong with the API call\nelse:\n  print \"Get Input File request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["VM_NAME","WORKING_DIR","ERA_BASE"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4GetProfileIDs","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Time Machine Capability\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/dbservers\/@@{SOURCE_DBSERVER_ID}@@?detailed=true&load-drive=false\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\nif resp.ok:\n  \n  # Cycle through the various properties\n  for property in json.loads(resp.content)['properties']:\n    \n    # Set the various variables\n    if property['name'] == \"compute_profile_id\":\n      print \"COMPUTE_PROFILE_ID={0}\".format(property['value'])\n    elif property['name'] == \"network_profile_id\":\n      print \"NETWORK_PROFILE_ID={0}\".format(property['value'])\n    elif property['name'] == \"db_parameter_profile_id\":\n      print \"DB_PROFILE_ID={0}\".format(property['value'])\n\n# In the event something went wrong with the API call\nelse:\n  print \"Get Profile ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["COMPUTE_PROFILE_ID","NETWORK_PROFILE_ID","DB_PROFILE_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5CloneDb","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Set the URL and payload\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/@@{Postgres.TM_ID}@@\/clones\"\npayload = {\n  \"snapshotId\": \"@@{VALIDATED_SNAP_ID}@@\",\n  \"cloneDescription\": \"Clone of '@@{db_name}@@' managed through Calm application @@{calm_application_name}@@\",\n  \"timeZone\": \"UTC\",\n  \"cloneName\": \"@@{db_name}@@-Clone@@{calm_array_index}@@\",\n  \"cloneInfo\": [\n    {\n      \"name\": \"db_password\",\n      \"value\": \"@@{db_password}@@\"\n    },\n    {\n      \"name\": \"vm_name\",\n      \"value\": \"@@{VM_NAME}@@\"\n    },\n    {\n      \"name\": \"client_public_key\",\n      \"value\": \"@@{db_server_creds.public_key}@@\"\n    },\n    {\n      \"name\": \"working_dir\",\n      \"value\": \"@@{WORKING_DIR}@@\"\n    },\n    {\n      \"name\": \"era_deploy_base\",\n      \"value\": \"@@{ERA_BASE}@@\"\n    },\n    {\n      \"name\": \"create_dbserver\",\n      \"value\": True\n    },\n    {\n      \"name\": \"compute_profile_id\",\n      \"value\": \"@@{COMPUTE_PROFILE_ID}@@\"\n    },\n    {\n      \"name\": \"network_profile_id\",\n      \"value\": \"@@{NETWORK_PROFILE_ID}@@\"\n    },\n    {\n      \"name\": \"db_parameter_profile_id\",\n      \"value\": \"@@{DB_PROFILE_ID}@@\"\n    }\n  ],\n  \"timeMachineId\": \"@@{Postgres.TM_ID}@@\",\n  \"latestSnapshot\": False\n}\n\n# Make the call and set the response operation ID to the variable\nresp = urlreq(url, verb='POST', auth='BASIC', user=era_user, passwd=era_pass, params=json.dumps(payload), headers=headers)\nif resp.ok:\n  print \"CLONE_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Post Database clone @@{name}@@ request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CLONE_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6MonitorOperation","attrs":{"exit_status":[],"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CLONE_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 60 seconds.\"\n  sleep(60)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break\n\n# If the operation did not complete within 20 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Get Operation ID timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get the newly provision DB Entity Name and set it to a variable\nprint \"CLONE_ENTITY_NAME={0}\".format(json.loads(resp.content)['entityName'])","eval_variables":["CLONE_ENTITY_NAME"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7GetDatabaseInfo","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get DB Server IP and ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/clones\/name\/@@{CLONE_ENTITY_NAME}@@?detailed=true\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"CLONE_SERVER_IP={0}\".format(json.loads(resp.content)['hostIP'])\n  print \"CLONE_ID={0}\".format(json.loads(resp.content)['id'])\n  print \"CLONE_SERVER_ID={0}\".format(json.loads(resp.content)['primaryHost'])\nelse:\n  print \"Get DB info request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CLONE_SERVER_IP","CLONE_ID","CLONE_SERVER_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"87328d5d_runbook","main_task_local_reference":{"kind":"app_task","name":"67bda28d_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1CleanupDB"},{"kind":"app_task","name":"2MonitorCleanupOp"},{"kind":"app_task","name":"3DeregisterDBServer"},{"kind":"app_task","name":"4MonitorDeregOp"}],"name":"d25d48c9_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1CleanupDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2MonitorCleanupOp"}},{"from_task_reference":{"kind":"app_task","name":"2MonitorCleanupOp"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3DeregisterDBServer"}},{"from_task_reference":{"kind":"app_task","name":"3DeregisterDBServer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4MonitorDeregOp"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1CleanupDB","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Cleanup the DB and get Operation ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/clones\/@@{CLONE_ID}@@?cleanup=true&delete-db=true\"\nresp = urlreq(url, verb='DELETE', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"CLEANUP_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\n  #print \"Success!\"\nelse:\n  print \"Cleanup Clone Operation failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CLEANUP_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2MonitorCleanupOp","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CLEANUP_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 30 seconds.\"\n  sleep(30)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 10 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Cleanup Operation timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n#sleep(60)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3DeregisterDBServer","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Cleanup the DB and get Operation ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/dbservers\/@@{CLONE_SERVER_ID}@@?remove=false&soft-remove=false&delete=true&delete-vm-snapshots=true&delete-vgs=true\"\nresp = urlreq(url, verb='DELETE', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"DEREGISTER_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Deregister DB Server Operation failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["DEREGISTER_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4MonitorDeregOp","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{DEREGISTER_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 30 seconds.\"\n  sleep(30)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 10 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Deregistration Operation timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"8fe5b1c1_runbook","main_task_local_reference":{"kind":"app_task","name":"d25d48c9_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"EXISTING_VM","name":"Era_PosgreSQL_Clone","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"db_server_creds"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{CLONE_SERVER_IP}@@"},"variable_list":[]}],"credential_definition_list":[{"username":"era","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"db_server_creds"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"era_creds"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Postgres"}],"name":"Postgres_Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Postgres_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"fiestadataload"}],"name":"58ca4a03_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"fiestadataload","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n# Generate the Postgres Network File\n\ncat << EOF > ~\/fiestapsg.sql\n\n-- MS SQL\n-- Database Name: Fiesta\n-- ------------------------------------------------------\n--\n\n\n--\n-- Table structure for table `products`\n--\n\nDROP TABLE IF EXISTS \"Products\";\nCREATE SEQUENCE \"Products_seq\";\n\nCREATE TABLE \"Products\" (\n  id INT PRIMARY KEY DEFAULT NEXTVAL ('\"Products_seq\"') ,\n  product_name varchar(255) NOT NULL,\n  product_price decimal(5,2) NOT NULL,\n  product_image_url text NOT NULL,\n  product_comment varchar(255) DEFAULT NULL,\n  comment text\n);\n\n\n--\n-- Dumping data for table `products`\n--\n\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('12 large ballons',2.30,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/BLOON_MET_GOLD__01_1000x.jpg?v=1571327220','On back order');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('Single Banquet Chair Cover',2.99,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/SASH_71_046_D04_0a16a508-5cd5-422f-ab7d-45acee11f6d1_1000x.jpg?v=1571323936','Vendor in on Wednesdays only.');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('90x132 Rectangle Table Cloth',24.50,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/TAB_02_5454_SILV__02_7bb66485-2943-489e-a7c7-8d3f2d810fc5.progressive.jpg?v=1571325198','Table cloth quality issues. Need to talk to vendor.');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('120\" Round Table Cloth',14.00,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/TAB_120_WHT-2_1000x.jpg?v=1571323057','Need double order next time.');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('5 Pack Linen Napkins',5.25,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/NAP_OSC_WHT_1000x.jpg?v=1571323239','Dont buy the gray ones. Only Beige or white colors sell.');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('12\"x108\" Inch Table Runner',2.42,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/RUN_STN_CHMP-2_large.progressive.jpg?v=1571323435','Vendor is discontinuing these July 2020.');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('21 FT Table Skirt',15.00,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/SKT_POLY_WHT_21__01_1000x.jpg?v=1571323258','Get more variety from vendor as per customers feedback. ');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('Pretty Flowers Center Piece',25.50,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/PROP_CUPK_001__02_1000x.jpg?v=1571323944',NULL);\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('10 Champagne Flutes',4.50,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/PLST_CU0071_GOLD_1000x.jpg?v=1571325883','Place an order with vendor of 24 packets by next Saturday.');\nINSERT INTO \"Products\" (product_name,product_price,product_image_url,product_comment) VALUES ('Confetti Squares',3.99,'https:\/\/cdn.shopify.com\/s\/files\/1\/1832\/6341\/products\/BOTT_GLIT_002_GOLD__02_1000x.jpg?v=1571327289','On back order.');\n\n--\n-- Table structure for table `stores`\n--\n\nDROP TABLE IF EXISTS \"Stores\";\nCREATE SEQUENCE \"Stores_seq\";\n\nCREATE TABLE \"Stores\" (\n  id INT PRIMARY KEY DEFAULT NEXTVAL ('\"Stores_seq\"') ,\n  store_name varchar(255) NOT NULL,\n  store_city varchar(255) NOT NULL,\n  store_state varchar(255) NOT NULL,\n  comment text\t\n);\n\n--\n-- Dumping data for table `stores`\n--\n\nINSERT INTO \"Stores\" (store_name,store_city,store_state) VALUES ('Party Xtravaganza','Durham','NC');\nINSERT INTO \"Stores\"(store_name,store_city,store_state) VALUES ('Party Xperience','San Jose','CA');\nINSERT INTO \"Stores\"(store_name,store_city,store_state) VALUES ('Party with Us','New York','NY');\nINSERT INTO \"Stores\" (store_name,store_city,store_state) VALUES ('IneXpensive Party','Northboro','Iowa');\n\n--\n-- Table structure for table `inventory`\n--\n\nDROP TABLE IF EXISTS \"InventoryRecords\";\nCREATE SEQUENCE \"InventoryRecords_seq\";\n\nCREATE TABLE \"InventoryRecords\" (\n  id INT PRIMARY KEY DEFAULT NEXTVAL ('\"InventoryRecords_seq\"') ,\n  product_id int NOT NULL,\n  product_name varchar(255) NOT NULL,\n  store_id int NOT NULL,\n  store_name varchar(255) NOT NULL,\n  quantity int DEFAULT '0',\n  local_price decimal(5,2) NOT NULL,\n  comment text\n);\n\n--\n-- Dumping data for table `inventory`\n--\n\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (2,'Single Banquet Chair Cover',1,'Party Xtravaganza',30,4.05,'These chair cover sell a lot in beige and dont sell enough in other colors. ');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (3,'90x132 Rectangle Table Cloth',1,'Party Xtravaganza',100,29.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (5,'5 Pack Linen Napkins',1,'Party Xtravaganza',10,6.99,'The best napkins, believe me. ');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (7,'21 FT Table Skirt',1,'Party Xtravaganza',56,17.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (8,'Pretty Flowers Center Piece',1,'Party Xtravaganza',100,29.99,'If not sold within first 24 hrs. Advertise as 50% off.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (9,'10 Champagne Flutes',1,'Party Xtravaganza',98,7.99,'Clear Plastic.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (1,'12 large ballons',2,'Party Xperience',47,2.99,'The biggest ballons');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (2,'Single Banquet Chair Cover',2,'Party Xperience',16,3.66,'Stretchy kind.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (3,'90x132 Rectangle Table Cloth',2,'Party Xperience',60,25.95,'These table cloths are not popular in this store.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (4,'120\" Round Table Cloth',2,'Party Xperience',1,15.99,'Good quality materials. popular product. Re-order.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (5,'5 Pack Linen Napkins',2,'Party Xperience',100,5.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (6,'12\"x108\" Inch Table Runner',2,'Party Xperience',23,3.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (7,'21 FT Table Skirt',2,'Party Xperience',0,18.99,'Sold out');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (8,'Pretty Flowers Center Piece',2,'Party Xperience',2,29.99,'If not sold within first 24 hrs. Advertise as 50% off.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (9,'10 Champagne Flutes',2,'Party Xperience',100,7.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (1,'12 large ballons',3,'Party with Us',100,3.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (2,'Single Banquet Chair Cover',3,'Party with Us',100,4.99,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (3,'90x132 Rectangle Table Cloth',3,'Party with Us',100,20.00,'On sale, discontinuing product.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (4,'120\" Round Table Cloth',3,'Party with Us',3,15.95,'Popular item.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (5,'5 Pack Linen Napkins',3,'Party with Us',64,4.99,'Order only light beige color next time.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (6,'12\"x108\" Inch Table Runner',3,'Party with Us',0,5.99,'Sold out. ');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (7,'21 FT Table Skirt',3,'Party with Us',100,0.00,'');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (8,'Pretty Flowers Center Piece',3,'Party with Us',3,25.99,'If not sold within first 24 hrs. Advertize as 50% off.');\nINSERT INTO \"InventoryRecords\" (product_id,product_name,store_id,store_name,quantity,local_price,comment) VALUES (9,'10 Champagne Flutes',3,'Party with Us',87,5.99,'Clear Plastic');\n\n\nEOF\n\npsql -U postgres -d @@{db_name}@@ -a -f ~\/fiestapsg.sql","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"db_server_creds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"8b1f1a7b_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"58ca4a03_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Postgres_Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"ee8bedbe_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"faacff5d_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"ee8bedbe_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Postgres_Clone"}],"name":"Package2","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"c270e669_dag","state":"NOT_VALIDATED","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"97d4aec3_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"c270e669_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"62139c25_dag","state":"NOT_VALIDATED","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8e3497e5_runbook","state":"NOT_VALIDATED","main_task_local_reference":{"kind":"app_task","name":"62139c25_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"f6be2786_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Postgres_Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"68fbb2c6_deployment","min_replicas":"1","default_replicas":"3","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"5","package_local_reference_list":[{"kind":"app_package","name":"Package2"}],"substrate_local_reference":{"kind":"app_substrate","name":"Era_PosgreSQL_Clone"},"variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1GetTimeMachineID"},{"kind":"app_task","name":"2GetSnapshotList"}],"name":"f5299bbc_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1GetTimeMachineID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2GetSnapshotList"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1GetTimeMachineID","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Time Machine ID\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/name\/@@{db_name}@@_tm?load-drive=false\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nif resp.ok:\n  print \"TM_ID={0}\".format(json.loads(resp.content)['id'])\nelse:\n  print \"Get Time Machine ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["TM_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2GetSnapshotList","attrs":{"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Time Machine Capability\nurl  = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/tms\/@@{TM_ID}@@\/capability?summary=false&time-zone=UTC\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\nif resp.ok:\n  \n  # Cycle through the snapshot modes\n  for modes in json.loads(resp.content)['capability']:\n    print \"{0} MODE\".format(modes['mode'])\n    \n    # Cycle through the snapshots if they exist\n    if modes['snapshots']:\n      for snapshot in modes['snapshots']:\n        print \"  ------------------------\"\n        print \"  Snapshot ID (copy this): {0}\".format(snapshot['id'])\n        print \"  Snapshot Time Stamp:     {0}\".format(snapshot['snapshotTimeStamp'])\n        \n    # Print message if the don't exist\n    else:\n      print \"  ------------------------\"\n      print \"  No {0} snapshots exist.\".format(modes['mode'].lower())\n\nelse:\n  print \"Get Time Machine Capability request failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"676e7778_runbook","main_task_local_reference":{"kind":"app_task","name":"f5299bbc_dag"},"variable_list":[]},"name":"GetSnapshotList"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"TakeSnapshot"}],"name":"fe7cea37_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"TakeSnapshot","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"c6692992_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"e79a5451_runbook","main_task_local_reference":{"kind":"app_task","name":"fe7cea37_dag"},"variable_list":[]},"name":"TakeSnapshot"}],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"compute_profile","value":"CUSTOM_SMALL","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"database_parameter","value":"DEFAULT_POSTGRES_PARAMS","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"db_name","value":"fiestadb1","label":"","editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"db_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"era_ip","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"network_profile","value":"DEFAULT_POSTGRES_NETWORK","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"sla_name","value":"DEFAULT_OOB_GOLD_SLA","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"software_profile","value":"POSTGRES_10.4_OOB","label":"","editables":{"value":true},"is_hidden":false}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"era_creds"},"type":"USER"},"name":"EraPostgresProvision"},"api_version":"3.0","metadata":{"last_update_time":"1589400784305413","kind":"blueprint","spec_version":20,"creation_time":"1589310305971272","name":"EraPostgresProvision"}}